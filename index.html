<html>
    <head>
        <title>Forked up Snakes</title>
    </head>
    <body>
        <canvas id="canvas" width="800" height="600"></canvas>
        <script>
            var canvas = document.getElementById('canvas');
            const WIDTH = canvas.width;
            const HEIGHT = canvas.height;
            var context = canvas.getContext('2d');
            var requestAnimationFrame = 
                requestAnimationFrame ||
                webkitRequestAnimationFrame ||
                mozRequestAnimationFrame ||
                msRequestAnimationFrame ||
                oRequestAnimationFrame;
            const dirUp = 0;
            const dirRight = 1;
            const dirDown = 2;
            const dirLeft = 3;

            var snakes = initSnakes();
            var activeSnake = snakes[0];
            var cellWidth = 10;
            var food = placeFood();

            window.addEventListener('keydown',handleKeyDown,true);
            requestAnimationFrame(loop);

            function loop() {
                context.clearRect(0, 0, WIDTH, HEIGHT);
                for(var i in snakes) {
                    //console.log("check");
                    drawSnake(snakes[i]);
                    updateSnake(snakes[i]);
                }
                //console.log("done");
                drawWall();
                drawCell(food, 'red');
                if(killSnakes()) {
                    console.log("dead");
                }
                window.setTimeout(function(){requestAnimationFrame(loop)}, 125);
            }

            function initSnakes() {
                var firstSnake = {cells:new Array()};
                for(var i=5; i>0; i--) {
                    firstSnake.cells.push({x:i, y:1});
                }
                firstSnake.dir = dirRight;
                firstSnake.prevDir = dirRight;
                firstSnake.color = 'blue';
                var secondSnake = {cells:new Array()};
                for(var i=10; i>0; i--) {
                    secondSnake.cells.push({x:i, y:2});
                }
                secondSnake.dir = dirRight;
                secondSnake.prevDir = dirRight;
                secondSnake.color = 'green';
                return [firstSnake,secondSnake];
            }

            function updateSnake(snake) {
                var cells = snake.cells;
                var head = cells[0];
                var tail = {x:head.x,y:head.y};
                switch(snake.dir) {
                    case dirUp:
                        tail.y--;
                        break;
                    case dirRight:
                        tail.x++;
                        break;
                    case dirDown:
                        tail.y++;
                        break;
                    case dirLeft:
                        tail.x--;
                        break;
                    default:
                        console.error('bad direction');
                }
                snake.cells.unshift(tail);
                snake.prevDir = snake.dir;
                if(head.x == food.x && head.y == food.y) {
                    food = placeFood();
                    if(snake.cells.length === 10) {
                        splitSnake(snake);
                    }
                } else {
                    cells.pop();
                }
            }

            function splitSnake(snake) {
                var newSnake = {cells:new Array()};
                for(var i=0; i<5; i++) {
                    newSnake.cells.push(snake.cells.pop());
                }
                var cells = newSnake.cells;
                if(cells[0].x+1 === cells[1].x) {
                    newSnake.dir = dirLeft;
                    newSnake.prevDir = dirLeft;
                } else if(cells[0].x-1 === cells[1].x) {
                    newSnake.dir = dirRight;
                    newSnake.prevDir = dirRight;
                } else if(cells[0].y+1 === cells[1].y) {
                    newSnake.dir = dirUp;
                    newSnake.prevDir = dirUp;
                } else if(cells[0].y-1 === cells[1].y) {
                    newSnake.dir = dirDown;
                    newSnake.prevDir = dirDown;
                }
                newSnake.color = 'green';
                snakes.push(newSnake);
            }

            // If you run into the side of another snake or yourself,
            // you cut off part of that snake.  If you have a head on
            // collision, both die, unless one snake is just a head,
            // in which case it dies and the other lives.
            function killSnakes() {
                for(var i=snakes.length-1; i>=0; i--) {
                    var snake = snakes[i];
                    var head = snake.cells[0];
                    if(head.x < 1 || head.x >= WIDTH/cellWidth-1) {
                        snakes.splice(i, 1);
                    } else if(head.y < 1 || head.y >= HEIGHT/cellWidth-1) {
                        snakes.splice(i, 1);
                    }
                    for(var j=snakes.length-1; j>=0; j--) {
                        for(var k in snakes[j].cells) {
                            if(j === i && k < 1) continue;
                            var cell = snakes[j].cells[k];
                            if(cell.x === head.x && cell.y === head.y) {
                                if(k === 0) {
                                    snakes.splice(j, 1);
                                    if(snakes[j].cells.length > 1) {
                                        snakes.splice(i, 1);
                                    }
                                } else {
                                    snakes[j].cells = snakes[j].cells.slice(0, k);
                                }
                                break;
                            }
                        }
                    }
                }
            }

            function drawCell(cell, color) {
                context.beginPath();
                var x = cell.x * cellWidth;
                var y = cell.y * cellWidth;
                context.rect(x, y, cellWidth, cellWidth);
                context.fillStyle = color;
                context.fill();
                context.lineWidth = 2;
                context.strokeStyle = 'white';
                context.stroke();
                context.closePath();
            }

            function placeFood() {
                var x = Math.random() * (WIDTH/cellWidth-2);
                x = Math.floor(x);
                x += 1;
                var y = Math.random() * (HEIGHT/cellWidth-2);
                y = Math.floor(y);
                y += 1;
                return {x:x, y:y};
            }

            function drawSnake(snake) {
                for(var i in snake.cells) {
                    drawCell(snake.cells[i], snake.color);
                }
            }

            function drawWall() {
                for(var x=0; x<WIDTH/cellWidth; x++) {
                    drawCell({x:x, y:0}, 'black');
                    drawCell({x:x, y:HEIGHT/cellWidth-1}, 'black');
                }
                for(var y=1; y<HEIGHT/cellWidth-1; y++) {
                    drawCell({x:0, y:y}, 'black');
                    drawCell({x:WIDTH/cellWidth-1, y:y}, 'black');
                }
            }

            function handleKeyDown(evt) {
                const keySpace = 32;
                const keyLeft = 37;
                const keyUp = 38;
                const keyRight = 39;
                const keyDown = 40;

                switch (evt.keyCode) {
                    case keySpace:
                        changeSnake();
                        break;
                    case keyLeft:
                        if(getActiveSnake().prevDir != dirRight)
                            getActiveSnake().dir = dirLeft;
                        break;
                    case keyUp:
                        if(getActiveSnake().prevDir != dirDown)
                            getActiveSnake().dir = dirUp;
                        break;
                    case keyRight:
                        if(getActiveSnake().prevDir != dirLeft)
                            getActiveSnake().dir = dirRight;
                        break;
                    case keyDown:
                        if(getActiveSnake().prevDir != dirUp)
                            getActiveSnake().dir = dirDown;
                        break;
                }
            }
            function changeSnake() {
                var oldSnake = getActiveSnake();
                oldSnake.color = 'green';
                
                var newPos = snakes.indexOf(oldSnake) + 1;
                if(newPos >= snakes.length)
                    newPos = 0;
                activeSnake = snakes[newPos];
                activeSnake.color = 'blue';
            }

            function getActiveSnake() { // Fixme
                return activeSnake;
            }

        </script>
    </body>
</html>
